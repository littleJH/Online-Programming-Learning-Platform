import{c as e,b as t,bH as a,bI as n,d as r,n as s,_ as i,t as c,m as o,bF as l,cn as m,j as d,a as u,l as h,M as f}from"./index.5c064301.js";import{s as p}from"./style.module.9ce82fca.js";import{M as b}from"./MyAvatar.22457dcc.js";const v=e({baseURL:"/competition/random/"});let x=new Map([]);const y=e=>{"number"==typeof e?(clearInterval(x.get(e)),x.delete(e)):(x.forEach((e=>clearInterval(e))),x.clear())},g=()=>{const[e,g]=n();r(s);const[M,w]=i.exports.useState(e.get("type")||"single"),[N,S]=i.exports.useState("undetermined"),[E,$]=i.exports.useState(!1),[k,C]=i.exports.useState([]),I=i.exports.useRef([]),W=i.exports.useRef(null),{token:j}=c.useToken(),{connectWs:H,closeWs:R}=o.useWsConnect({wsUrl:`${a}/competition/random/single/enter/publish`,onMessage:e=>_(e),onOpen:()=>$(!0),onClose:()=>$(!1),onFail:()=>B(),immediately:!1});i.exports.useEffect((()=>(z(),()=>{R(),B()})),[M]),i.exports.useEffect((()=>{I.current=k,I.current.length&&I.current.forEach(((e,t)=>{(e=>{if(x.has(e))return;const t=document.querySelector(`#avatar${e}`),a=document.getElementById("matchContainer");if(!t||!a)return;let n=!1,r=2*(Math.random()-.5)*3,s=2*(Math.random()-.5)*3,i=Math.random()*(a.clientWidth-t.clientWidth),c=Math.random()*(a.clientHeight-t.clientHeight);const o=a.clientHeight,l=a.clientWidth,m=t.clientHeight,d=t.clientWidth;t.addEventListener("mouseenter",(()=>n=!0)),t.addEventListener("mouseleave",(()=>n=!1)),x.set(e,setInterval((()=>{n||(i+=r,c+=s,(i<0||i+d>l)&&(r=-r),(c<0||c+m>o)&&(s=-s),t.style.opacity="1",t.style.left=`${i}px`,t.style.top=`${c}px`)}),1e3/60))})(e.member.id)}))}),[k]);const z=async()=>{const e=await(e=>v.get(`${e}/enter/condition`,t()))(M);S(e.data.data.enter?"enter":"notEnter"),e.data.data.enter&&(H(),L())},L=async()=>{const e=await(e=>v.get(`${e}/enter/list`))(M),t=e.data.data.competitionRanks,a=[];for(let n of t){const e=await l(n.Member);a.push({enter_time:m.unix(n.Score).format().toString(),member:e.data.data.user})}C(a)},B=async()=>{R();const e=await(e=>v.delete(`${e}/cancel/enter`,t()))(M);200===e.data.code&&(S("notEnter"),C([]),y())},_=e=>{var t;switch(e.Score){case 0:const a=I.current.findIndex((t=>t.member.id===e.Member));C((e=>[...e.slice(0,a),...e.slice(a+1)])),y(null==(t=I.current.find((t=>t.member.id===e.Member)))?void 0:t.member.id);break;case-1:break;default:l(e.Member).then((t=>{C((a=>[...a,{enter_time:m.unix(e.Score).format().toString(),member:t.data.data.user}]))}))}};return d("div",{className:p.randomRoot,children:["notEnter"===N&&u("div",{className:p.enterButton,children:u(h,{className:p.button,icon:u(f,{href:"#icon-pipei",color:j.colorPrimary,size:4,classname:p.icon}),size:"large",onClick:async()=>{const e=await(e=>v.post(`${e}/enter`,{},t()))(M);200===e.data.code&&(S("enter"),L(),H())},children:"进入比赛"})}),"enter"===N&&u("div",{className:p.matchBox,children:d("div",{ref:W,id:"matchContainer",className:p.matchCtn,children:[u("div",{className:"flex-grow h-full",children:u("div",{className:p.memberList,children:k.map(((e,t)=>u("div",{id:`avatar${e.member.id}`,className:p.memberItem,children:u(b,{size:60,user:e.member,active:!0})},e.member.id+String(t))))})}),d("div",{className:"flex flex-col items-center",children:[u("div",{className:"h-full flex justify-center items-center",children:u(f,{href:"#icon-pipei",classname:p.rotate,color:j.colorPrimary,size:5})}),u(h,{style:{width:"6rem",marginTop:"2rem"},type:"primary",onClick:()=>{B()},children:"取消匹配"})]}),u("div",{className:"flex-grow h-full"})]})})]})};export{g as default};
