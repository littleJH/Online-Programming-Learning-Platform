import{_ as e,a as t,A as r,c as o,b as s,bH as a,bz as n,aZ as i,d as l,i as c,e as d,t as m,m as u,j as p,aU as h,F as f,l as v,bF as g,o as x,p as b,bI as j,n as y,bJ as C}from"./index.5c064301.js";import{g as k,a as w,b as N,s as S,c as $}from"./group.ab80a5d7.js";import{G as I}from"./GroupInfo.bc6bb5e5.js";import{U as z}from"./UserInfo.2df9e32c.js";import{s as M}from"./style.module.dc2582af.js";import{L as O}from"./index.0ec24622.js";import{I as R,T as B}from"./index.7d75d2c2.js";import{D as L}from"./index.79a1b64c.js";import{C as _}from"./index.9225dd62.js";import{C as D}from"./CreateGroupForm.513a2dca.js";import{s as U}from"./style.module.b5b5c35b.js";import{F}from"./index.0c9dd83b.js";import{M as G}from"./index.6891d53f.js";import{P}from"./PlusOutlined.787b1bb7.js";import"./MyAvatar.22457dcc.js";import"./index.972659d0.js";import"./index.7aeb2011.js";import"./index.a45f76a6.js";import"./context.aa52cc0c.js";import"./List.6e377c69.js";import"./PurePanel.bec90387.js";import"./index.4e624168.js";import"./useLocale.07149357.js";import"./CheckOutlined.363c4795.js";import"./UpOutlined.722986ed.js";import"./BaseInput.01760c9b.js";import"./message.856d7a68.js";import"./WomanOutlined.2213c8b5.js";import"./row.e491f7a6.js";import"./index.77ceaa6f.js";import"./Skeleton.ed2cb458.js";import"./Pagination.855f4d50.js";import"./useClosable.e9e9bb76.js";import"./Dropdown.acaf0b68.js";import"./index.05a8036e.js";import"./MinusCircleOutlined.59c26db9.js";import"./ActionButton.76c967e9.js";import"./fade.9766c3a1.js";const E={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM142.4 642.1L298.7 519a8.84 8.84 0 000-13.9L142.4 381.9c-5.8-4.6-14.4-.5-14.4 6.9v246.3a8.9 8.9 0 0014.4 7z"}}]},name:"menu-unfold",theme:"outlined"};var H=function(e,o){return t(r,{...e,ref:o,icon:E})};const T=e.exports.forwardRef(H),A=o({baseURL:"letter"}),W=o({baseURL:"chat"}),J=r=>{const{group:o,friend:j,setOpenGroupDrawer:y}=r,C=l(c),k=l(d),w=e.exports.useRef(null),[N,S]=e.exports.useState(!1),[$,B]=e.exports.useState(""),[D,U]=e.exports.useState([]),[F,G]=e.exports.useState(!0),P=e.exports.useRef(null),{token:E}=m.useToken();u.useWsConnect({wsUrl:function(){if(o)return e=o.id,`${a}/chat/receive/${e}?token=${localStorage.getItem("token")}`;var e;if(j)return(e=>`${a}/letter/receive/${e}?token=${localStorage.getItem("token")}`)(j.id)}(),onMessage:function(e){U((t=>[...t,e]))}}),e.exports.useEffect((()=>{H()}),[o]);const H=()=>{G(!0);const e=async e=>{const t=e.data.data.chats,r=[];if(!t)return U([]),void G(!1);for(let o of t){const e=await g(o.author_id);r.push({chat:{...o},user:e.data.data.user})}U(r.reverse()),G(!1)};var t;o&&(t=o.id,W.get(`/list/${t}`,s())).then(e),j&&(e=>A.get(`/list/${e}`,s()))(j.id).then(e)};const J=()=>{if(!$.length)return;const e=e=>{200===e.data.code&&(B(""),setTimeout((()=>{var e;null==(e=P.current)||e.scrollIntoView({behavior:"smooth",block:"end"})}),0))};var t,r;o&&(t=o.id,r=JSON.stringify({content:$}),W.post(`/send/${t}`,r,i())).then(e),j&&((e,t)=>A.post(`/send/${e}`,t,n()))(j.id,JSON.stringify({content:$})).then(e)},K=e=>{const r=e.chat.author_id===(null==k?void 0:k.id);return p("div",{id:e.chat.group_id,className:"w-full flex justify-"+(r?"end":"start"),children:[!r&&t(x,{src:`${b}/${e.user.icon}`,style:{flex:"none"}}),t("div",{style:{maxWidth:"75%"},children:t(_,{size:"small",style:{margin:"0 1rem",backgroundColor:`${r?E.colorPrimaryBg:""}`},children:e.chat.content})}),r&&t(x,{src:`${b}/${e.user.icon}`,style:{flex:"none"}})]})};return p("div",{className:M.IMCard,children:[p("div",{className:M.header,children:[p("div",{className:"sticky top-0 z-10 flex justify-between items-center",style:{borderBottom:`1px solid ${E.colorBorder}`},children:[p("span",{className:"mx-4 my-2 text-lg",children:[C&&t(T,{onClick:()=>y&&y(!0),style:{marginRight:"1rem"}}),o&&o.title,j&&j.name]}),t("span",{className:"mx-2",onClick:()=>{S(!0)},children:t(h,{style:{fontSize:"2rem",cursor:"pointer"}})})]}),t("div",{className:"h-full grow px-8 overflow-auto",children:t("div",{ref:P,children:t(O,{loading:F,split:!1,dataSource:D,renderItem:(e,r)=>t(f,{children:e.chat.content&&t(O.Item,{onLoad:()=>{var e;r===D.length-1&&(null==(e=P.current)||e.scrollIntoView({behavior:"smooth",block:"end"}))},children:K(e)},`${e.chat.author_id}${e.chat.created_at}`)})})})})]}),p("div",{className:M.footer,style:{borderColor:E.colorBorder},onClick:()=>{var e;return null==(e=w.current)?void 0:e.focus()},children:[t("div",{className:M.inputBox,children:t(R.TextArea,{ref:w,value:$,onChange:e=>B(e.target.value),variant:"borderless",autoSize:{minRows:1,maxRows:3},onKeyDown:e=>{"Enter"===e.key&&(e.shiftKey?B((e=>`${e}\n`)):(e.preventDefault(),J()))}})}),t("div",{className:"h-full flex items-end",children:t(v,{className:"mr-4 mb-4",type:"primary",onClick:J,children:"发送"})})]}),p(L,{placement:C?"bottom":"right",closeIcon:null,open:N,onClose:()=>S(!1),children:[o&&t(I,{group:o}),j&&t(z,{user:j})]})]})},K=()=>{const r=l(c),{Search:o}=R,[s,n]=j(),[i,h]=e.exports.useState(s.get("group_id")),g=l(d),[x,b]=e.exports.useState(0),[z,M]=e.exports.useState(""),[O,_]=e.exports.useState([]),[E,H]=e.exports.useState(!1),[T,A]=e.exports.useState(!1),[W,K]=e.exports.useState(!r),[V,Z]=e.exports.useState(!1),[q,Q]=e.exports.useState(`我是${null==g?void 0:g.name}`),X=l(y),[Y]=F.useForm(),{token:ee}=m.useToken(),te=e.exports.useRef(null);u.useWsConnect({wsUrl:`${a}/chat/receivelink?token=${localStorage.getItem("token")}`,onOpen:e=>ne(),onMessage:e=>ie(),onClose:e=>le()});const re=e.exports.useMemo((()=>O.find((e=>e.id===i))),[i,O]),oe=e.exports.useMemo((()=>z?"search":"default"),[z]),se=e.exports.useMemo((()=>O.map((e=>({key:e.id,label:t("div",{onClick:()=>ce({key:e.id}),children:e.title})})))),[O]);e.exports.useEffect((()=>{ae()}),[]),e.exports.useEffect((()=>{var e;!r&&!i&&O.length>0&&h(null==(e=O[0])?void 0:e.id)}),[O]),e.exports.useEffect((()=>{i&&n([["group_id",i]])}),[i]);const ae=()=>{g&&(M(""),k(null==g?void 0:g.id).then((async e=>{b(e.data.data.total);const t=e.data.data.userList,r=[];for(let o of t){const e=await w(o.group_id);200===e.data.code&&r.push({...e.data.data.group})}_(r.reverse())})))},ne=e=>{},ie=e=>{},le=e=>{},ce=e=>{r&&"search"===oe&&(K(!1),Z(!0)),h(e.key)},de=async e=>{if(e)try{const t=(await S(e)).data.data.groups;for(let e of t)e.entered=(await $(e.id)).data.data.member;_(t)}catch{}},me=async()=>{if(!(null==re?void 0:re.auto)&&""===q)return void(null==X||X.warning({message:"请输入申请信息"}));const e=new FormData;e.append("content",q),(null==re?void 0:re.id)&&N(null==re?void 0:re.id,e).then((e=>{}))},ue=()=>p("div",{className:U.groupList,children:[p("div",{className:U.space,children:[t(o,{size:r?"middle":"small",value:z,enterButton:!0,allowClear:!0,onSearch:de,onChange:e=>{M(e.target.value),e.target.value?de(e.target.value):ae()}}),t(v,{size:r?"middle":"small",className:"ml-4",onClick:()=>A(!0),children:t(P,{})})]}),t("div",{className:"overflow-auto h-96 grow",children:t(C,{className:"p-4",items:se,selectedKeys:[i||""],onSelect:ce})})]}),pe=()=>t(f,{children:re&&p("div",{className:"p-8",children:[t(I,{group:re}),p("div",{className:"w-full text-end",children:[t(v,{type:"primary",onClick:()=>{Z(!1),K(!0)},children:"返回"}),re.entered?t(v,{type:"primary",className:"ml-4",onClick:()=>{K(!1),Z(!1),M("")},children:"进入聊天"}):t(v,{type:"primary",className:"ml-4",onClick:()=>re.auto?me():H(!0),children:"加入小组"})]})]})});return p("div",{ref:te,className:U.group,children:[r?p(f,{children:[t(L,{placement:"bottom",open:W,closeIcon:null,onClose:()=>{M(""),K(!1)},children:ue()}),t(L,{open:V,closeIcon:null,onClose:()=>Z(!1),placement:"bottom",children:pe()})]}):ue(),p("div",{className:U.right,style:{borderColor:ee.colorBorder,borderRadius:ee.borderRadius},children:[re&&p(f,{children:["default"===oe&&t(J,{group:re,setOpenGroupDrawer:K}),"search"===oe&&!r&&p(f,{children:[re.entered&&t(J,{group:re,setOpenGroupDrawer:K}),!re.entered&&pe()]})]}),!re&&r&&t("div",{className:"p-4 w-full h-full",children:ue()})]}),t(G,{open:E,title:"申请信息",onCancel:()=>H(!1),footer:[t(v,{type:"primary",onClick:me,children:"加入"})],children:t(B,{value:q,onChange:e=>Q(e.target.value)})}),t(G,{open:T,title:"创建用户组",onCancel:()=>A(!1),footer:[],children:t(D,{form:Y,doneCallback:e=>{X&&X.success({message:"用户组创建成功"}),M(""),h(e.id),_((t=>[e,...t])),A(!1)}})})]})};export{K as default};
